<!DOCTYPE html>
<html>
<head>
	<title>UBIQ - Users controller</title>

    <meta charset="UTF-8">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Sarabun:100,200,300,400,500,600,700,800" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
</head>
<body style="background: linear-gradient(to bottom, #005c97, #363795) fixed;">

<!-- Nav bar -->
	<nav class="navbar bg-dark text-white">
	  <a class="navbar-brand">
	    <img src="Logo.png" width="30" height="30" class="d-inline-block align-top" alt="">
	    User Controller
	  </a>
	  <a class="btn text-white my-2 my-sm-0" onclick="logOut()" href="login.html">Logout</a>
	</nav>
	<div class="container"></div>

<!-- Form -->
<div class="container d-flex justify-content-center mt-5 mb-5" style="border-radius: 10px">

	<form id="form" style="width: 300px;" class="text-center">
		<h4 class="text-white text-center mb-5">Create a new user</h4>
		<div class="form-group">
		    <input type="name" class="form-control" id="name" placeholder="Enter name">
  		</div>
		<div class="form-group">
		    <input type="email" class="form-control" id="email" placeholder="Enter email">
  		</div>
  		<div class="form-group">
		    <input type="password" class="form-control" id="password" placeholder="Enter password">
  		</div>
		<button onclick="create()" value="crear usuario" class="btn btn-primary">Crear</button>
	</form>
	<p id="error" class="hidden, error"></p>
</div>
	

<!-- List --> 
<div class="container" style="background-color: white">
	<table id="usersList" class="table table-hover">
	  <tbody></tbody>
	</table>

	<form class="form-inline" id="modifyingForm">
		<div class="form-group mx-sm-3 mb-2">
		    <input type="email" class="form-control" id="newEmail" placeholder="New email">
	  	</div>
		<div class="form-group mx-sm-3 mb-2">
		    <input type="password" class="form-control" id="newPassword" placeholder="New password">
		</div>
		<div class="form-group mx-sm-3 mb-2">
			<button type="submit" class="btn btn-primary mb-2">Modify</button>
		</div>
		
	</form>
</div>
</body>

<!-- JS -->
<script type="text/javascript">
	
	$("#form").submit(function(e){
		e.preventDefault();
	});

	var token = localStorage.getItem("token"); 
	var name = document.getElementById("name").value;

	if(!token){
		window.location = "login.html";
	}

	/*if(token.role_id != 1){
		console.log(token.role_id);
		window.location = "login.html";

	}*/
	
	//comprobar token
	$.ajax({
		url:"http://localhost:8888/ubiq/public/api/user",
		type: "GET",

		headers:
		{				
			'Authorization' : token
		},

		success: function(response){
			var users = response.users;
			showUsers(users);
		},
			
		error: function() {
			console.log("Error :(");
		}
	});

	function create() { 
		var name = $("#name").val();
        var email = $("#email").val();
        var password = $("#password").val();
        $.ajax({
           type: "POST",
           url: 'http://localhost:8888/ubiq/public/api/user',
           
           data: {
            'name':name,
            'password':password,
            'email':email                
           },
           
           success: function(response){

             console.log("Usuario creado", response.responseJSON);
           },

           error: function(response){
           		console.log(response.responseJSON);          
                $('#error').text(response.responseJSON);
                $('#error').removeClass('hidden');
           }
       });
	}

	function showUsers(users){
		if(users == null){
			$('#usersList').append('<div><p>Todav√≠a no hay usuarios creados</p></div>')
		}

		for(var user in users){
			if()
			$('#usersList').append('<tr><th scope="row">'+users[user].id+'</th><td>'+users[user].name+'</td><td>'+users[user].email+'</td><td><button onclick="modify()" class="btn btn-primary">Modify</button></td><td><button onclick="block()" class="btn btn-danger">Block</button></td></tr>');
		}
	}

	function logOut()
	{
		console.log("Log out");
		localStorage.clear();
		window.location = "http://localhost:8888/ubiq-client/login.html";  
	}

	function block(){

	}

	function modify(){
		var name = $("#name").val();
	    	var email = $("#email").val();
	    	var password = $("#password").val();
		
			$.ajax({
	        	type: "PUT",
	        	url: 'http://localhost:8888/ubiq/public/api/user/',
	           
	           data: {
	            'name':name,
	            'password':password,
	            'email':email                
	           },
	           
	           success: function(response){

	             console.log("User modified", response.responseJSON);
	           },

	           error: function(response){
	           		console.log(response.responseJSON);          
	                $('#error').text(response.responseJSON);
	                $('#error').removeClass('hidden');
	           }
	       	});
	}

</script>
</html>
